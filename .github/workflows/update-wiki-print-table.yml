# .github/workflows/update-wiki-print-table.yml
name: üõ†Ô∏è Auto-refresh 3-D-Print Checklist (Wiki)

on:
  # run every time anything in 3D_Printing/ changes‚Ä¶
  push:
    paths: ["3D_Printing/**"]
  # ‚Ä¶plus a nightly safety-net
  schedule:
    - cron: "0 3 * * *"     # 03:00 UTC

permissions:
  contents: read            # checkout needs this (wiki pushes use PAT below)

jobs:
  refresh:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£  Pull main repo ‚Äî for the generator script & models
    - name: Check out code
      uses: actions/checkout@v4

    # 2Ô∏è‚É£  Clone the Wiki repo (needs a token with *write* access)
    - name: Clone wiki repo
      env:
        # Use your PAT if set, otherwise the built-in token
        GH_PAT: ${{ secrets.GH_PAT }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        TOKEN="${GH_PAT:-$GITHUB_TOKEN}"
        git clone "https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.wiki.git" wiki

    # 3Ô∏è‚É£  Set up Python
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # 4Ô∏è‚É£  Install dependencies
    - name: Install deps
      run: |
        python -m pip install --upgrade pip
        pip install PyGithub tabulate markdown-it-py pyyaml

    # 5Ô∏è‚É£  Regenerate the table (preserve check-marks, merge .meta.yml)
    - name: Generate checklist markdown
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python scripts/make_print_table.py \
          --wiki-path wiki \
          --page "Build-Instruction:-3D-Printed-Parts.md"

    # 6Ô∏è‚É£  Commit & push only if the file changed
    - name: Commit & push update
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e
        cd wiki
        git add "Build-Instruction:-3D-Printed-Parts.md"

        if git diff --cached --quiet; then
          echo "No changes ‚Äì wiki already up to date."
        else
          git config user.name  "Mimic-CI Bot"
          git config user.email "actions@github.com"
          git commit -m "docs: auto-refresh 3-D print checklist [skip ci]"
          TOKEN="${GH_PAT:-$GITHUB_TOKEN}"
          git push "https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.wiki.git" HEAD:master
        fi
