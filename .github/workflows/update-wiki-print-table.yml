name: üõ†Ô∏è Auto-refresh 3D-Print Checklist (Wiki)

on:
  push:
    paths:
      - "3D_Printing/**"
  schedule:
    - cron: "0 3 * * *"          # daily safety-net

jobs:
  refresh:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£  Pull the main repo
    - name: Check out code
      uses: actions/checkout@v4

    # 2Ô∏è‚É£  Set up Python
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # 3Ô∏è‚É£  Install tiny deps
    - name: Install deps
      run: |
        python -m pip install --upgrade pip
        pip install PyGithub tabulate markdown-it-py pyyaml

    # 4Ô∏è‚É£  Generate the markdown once
    - name: Generate checklist markdown
      run: |
        python scripts/make_print_table.py \
          > "Build-Instruction:-3D-Printed-Parts.md"

    # 5Ô∏è‚É£  Verify the file exists (debug helper)
    - name: Show generated file
      run: |
        ls -l "Build-Instruction:-3D-Printed-Parts.md" | cat
        head -n 10 "Build-Instruction:-3D-Printed-Parts.md"

    # 6Ô∏è‚É£  Clone the Wiki repo
    - name: Clone wiki
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
      run: |
        git clone \
          "https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.wiki.git" \
          wiki

    # 7Ô∏è‚É£  Copy file, commit & push if it changed
    - name: Copy into wiki and commit
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
      run: |
        set -e
        cp "Build-Instruction:-3D-Printed-Parts.md" wiki/
        cd wiki
        git add "Build-Instruction:-3D-Printed-Parts.md"

        # Only commit when the file differs
        if git diff --cached --quiet; then
          echo "No changes ‚Äì wiki already up to date."
        else
          git config user.name  "Mimic-CI Bot"
          git config user.email "actions@github.com"
          git commit -m "docs: auto-refresh 3-D print checklist [skip ci]"
          git push origin HEAD
        fi
