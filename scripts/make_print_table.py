#!/usr/bin/env python3
"""
Generate a GitHub-flavoured Markdown checklist of every STL / 3MF
under 3D_Printing/ in the ISS-Mimic repo.

Usage (CI runner):
    python scripts/make_print_table.py \
        > "Build-Instruction:-3D-Printed-Parts.md"

Locally you can run it without any token, or set one:
    export GH_PAT=ghp_XXXXXXXXXXXXXXXX
    python scripts/make_print_table.py
"""

import os
import textwrap
from github import Github       # pip install PyGithub
from tabulate import tabulate   # pip install tabulate

# ——————————————————————————
# 1.  Repo settings
# ——————————————————————————
REPO = "ISS-Mimic/Mimic"        # owner/name
PATH = "3D_Printing"            # top-level folder that holds the parts

# ——————————————————————————
# 2.  Authentication
# ——————————————————————————
# Prefer your personal PAT if provided, else use the runner’s GITHUB_TOKEN,
# else go anonymous (lowest rate-limit, but OK for quick local runs).
TOKEN = (
    os.getenv("GH_PAT") or
    os.getenv("GITHUB_TOKEN") or
    None
)

gh = Github(TOKEN) if TOKEN else Github()

# ——————————————————————————
# 3.  Collect STL / 3MF paths
# ——————————————————————————
tree = gh.get_repo(REPO).get_git_tree("main", recursive=True).tree

parts = [
    n.path for n in tree
    if n.type == "blob"
    and n.path.startswith(PATH)
    and n.path.lower().endswith((".stl", ".3mf"))
]

# ——————————————————————————
# 4.  Build the table rows
# ——————————————————————————
rows = [
    [
        f"- [ ] `{p.split('/')[-1]}`",       # unchecked box + file name
        "",                                 # Qty (fill in later)
        "",                                 # Material
        p.replace(f"{PATH}/", "")           # Path relative to 3D_Printing/
    ]
    for p in sorted(parts, key=str.lower)
]

header = ["Print", "Qty", "Material", "Path in repo"]
md_body = tabulate(rows, headers=header, tablefmt="github")

front_matter = textwrap.dedent(
    """\
    <!--
    Auto-generated by make_print_table.py
    Run the script after adding/removing STL/3MF files.
    -->
    # ISS Mimic – 3-D Printing Checklist

    Paste this table into the project wiki and tick things off as you go.
    """
).rstrip()

print(front_matter, "\n\n", md_body, sep="")
