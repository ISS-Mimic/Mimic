#:import dp kivy.metrics.dp

# --------------------------------------------------------------------------
#  Re-usable mixins
# --------------------------------------------------------------------------
<TelemetryLabel@Label>:
    color: 1, 1, 1, 1
    font_size: min(self.height * 0.2, dp(30))  # Responsive with max size
    size_hint_y: 0.2

<PassLabel@Label>:
    color: 1, 1, 1, 1
    halign: "center"
    font_size: min(self.height * 0.17, dp(18))  # Responsive with max size
    size_hint_y: 0.2

<NavButton@Button>:
    size_hint: .12, .18
    background_down: self.background_normal.replace("Unlit", "Down") if self.background_normal else ""

# --------------------------------------------------------------------------
#  Orbit screen — telemetry, ISS pass, nav
# --------------------------------------------------------------------------
<Orbit_Screen>:
    name: "orbit"

    # ───────────────────────── Background & static images ──────────────────
    Image:
        id: Orbit_background
        source: f"{root.mimic_directory}/Mimic/Pi/imgs/orbit/OrbitBackground.png"
        fit_mode: "fill"

    Image:
        id: orbit3d
        source: f"{root.mimic_data_directory}/globe.png"
        size_hint: 0.20, 0.20
        pos_hint: {"center_x": 0.92, "center_y": 0.35}
        fit_mode: "contain"

    Image:
        id: OrbitMap
        source: f"{root.mimic_data_directory}/map.jpg"
        pos_hint: {"center_x": 0.50, "center_y": 0.56}
        size_hint_y: 0.598
        fit_mode: "contain"

    # ───────────────────────── Global time & signal colour ─────────────────
    Label:
        id: gmtime
        pos_hint: {"center_x": 0.95, "center_y": 0.96}
        text: "00:00:00"
        color: root.signalcolor
        size_hint_y: 0.4
        font_size: min(self.height * 0.10, dp(32))  # Responsive with max size
        markup: True

    # ───────────────────────── Sun, ISS icon & ground tracks ───────────────
    Image:
        id: sun_icon
        source: f"{root.mimic_directory}/Mimic/Pi/imgs/orbit/OrbitSun.png"
        size_hint: None, None
        size: min(dp(80), self.parent.width * 0.06), min(dp(80), self.parent.height * 0.06)  # Responsive size
        pos: 0, 0  # set in python
    
    # ISS icon & track
    Image:
        id: iss_icon
        source: f"{root.mimic_directory}/Mimic/Pi/imgs/orbit/OrbitYellowISSicon.png"
        size_hint: None, None
        size: min(dp(60), self.parent.width * 0.05), min(dp(60), self.parent.height * 0.05)  # Responsive size
        pos: 0, 0                        
        canvas.after:
            Color:
                rgba: 1, 1, 1, 1         
            Line:
                width: max(1, dp(0.5))  # Responsive line width
                circle:
                    (self.center_x, self.center_y, min(self.width, self.height) / 2, 0, 360, 20)

    # ISS ground track lines
    Widget:
        id: iss_track_line_a
        canvas:
            Color:
                rgba: 1, 1, 0, 1           
            Line:
                points: []                 
                width: max(1, dp(0.5))  # Responsive line width

    Widget:
        id: iss_track_line_b
        canvas:
            Color:
                rgba: 1, 1, 0, 1
            Line:
                points: []
                width: max(1, dp(0.5))  # Responsive line width

    # ──────────────────────────── TDRS Satellites ─────────────────────────
    # EAST — TDRS 6 & 12 (Red)
    Widget:
        id: TDRS6
        size_hint: None, None
        size: min(dp(16), self.parent.width * 0.006), min(dp(16), self.parent.height * 0.006)  # Responsive size
        pos: 0, 0
        canvas:
            Color:
                rgba: 1, 0, 0, 1  # Red
            Ellipse:
                pos: self.pos
                size: self.size

    # Active TDRS circle for TDRS6
    Widget:
        id: TDRS6_active_circle
        size_hint: None, None
        size: min(dp(32), self.parent.width * 0.012), min(dp(32), self.parent.height * 0.012)  # Responsive size
        pos: 0, 0
        canvas:
            Color:
                rgba: 1, 1, 0, 0  # Yellow circle for active TDRS
            Ellipse:
                pos: self.pos
                size: self.size

    Widget:
        id: TDRS6_track
        canvas:
            Color:
                rgba: 1, 0, 0, 0.5  # Red, semi-transparent
            Line:
                points: []
                width: max(1, dp(0.5))  # Responsive line width

    Widget:
        id: TDRS12
        size_hint: None, None
        size: min(dp(16), self.parent.width * 0.006), min(dp(16), self.parent.height * 0.006)  # Responsive size
        pos: 0, 0
        canvas:
            Color:
                rgba: 1, 0, 0, 1  # Red
            Ellipse:
                pos: self.pos
                size: self.size

    # Active TDRS circle for TDRS12
    Widget:
        id: TDRS12_active_circle
        size_hint: None, None
        size: min(dp(32), self.parent.width * 0.012), min(dp(32), self.parent.height * 0.012)  # Responsive size
        pos: 0, 0
        canvas:
            Color:
                rgba: 1, 1, 0, 0  # Yellow circle for active TDRS
            Ellipse:
                pos: self.pos
                size: self.size

    Widget:
        id: TDRS12_track
        canvas:
            Color:
                rgba: 1, 0, 0, 0.5  # Red, semi-transparent
            Line:
                points: []
                width: max(1, dp(0.5))  # Responsive line width

    # Z-BELT — TDRS 7 & 8 (Green)
    Widget:
        id: TDRS7
        size_hint: None, None
        size: min(dp(16), self.parent.width * 0.006), min(dp(16), self.parent.height * 0.006)  # Responsive size
        pos: 0, 0
        canvas:
            Color:
                rgba: 0, 1, 0, 1  # Green
            Ellipse:
                pos: self.pos
                size: self.size

    # Active TDRS circle for TDRS7
    Widget:
        id: TDRS7_active_circle
        size_hint: None, None
        size: min(dp(32), self.parent.width * 0.012), min(dp(32), self.parent.height * 0.012)  # Responsive size
        pos: 0, 0
        canvas:
            Color:
                rgba: 1, 1, 0, 0  # Yellow circle for active TDRS
            Ellipse:
                pos: self.pos
                size: self.size

    Widget:
        id: TDRS7_track
        canvas:
            Color:
                rgba: 0, 1, 0, 0.5  # Green, semi-transparent
            Line:
                points: []
                width: max(1, dp(0.5))  # Responsive line width

    Widget:
        id: TDRS8
        size_hint: None, None
        size: min(dp(16), self.parent.width * 0.006), min(dp(16), self.parent.height * 0.006)  # Responsive size
        pos: 0, 0
        canvas:
            Color:
                rgba: 0, 1, 0, 1  # Green
            Ellipse:
                pos: self.pos
                size: self.size

    # Active TDRS circle for TDRS8
    Widget:
        id: TDRS8_active_circle
        size_hint: None, None
        size: min(dp(32), self.parent.width * 0.012), min(dp(32), self.parent.height * 0.012)  # Responsive size
        pos: 0, 0
        canvas:
            Color:
                rgba: 1, 1, 0, 0  # Yellow circle for active TDRS
            Ellipse:
                pos: self.pos
                size: self.size

    Widget:
        id: TDRS8_track
        canvas:
            Color:
                rgba: 0, 1, 0, 0.5  # Green, semi-transparent
            Line:
                points: []
                width: max(1, dp(0.5))  # Responsive line width

    # WEST — TDRS 10 & 11 (Blue)
    Widget:
        id: TDRS10
        size_hint: None, None
        size: min(dp(16), self.parent.width * 0.006), min(dp(16), self.parent.height * 0.006)  # Responsive size
        pos: 0, 0
        canvas:
            Color:
                rgba: 0, 0, 1, 1  # Blue
            Ellipse:
                pos: self.pos
                size: self.size

    # Active TDRS circle for TDRS10
    Widget:
        id: TDRS10_active_circle
        size_hint: None, None
        size: min(dp(32), self.parent.width * 0.012), min(dp(32), self.parent.height * 0.012)  # Responsive size
        pos: 0, 0
        canvas:
            Color:
                rgba: 1, 1, 0, 0  # Yellow circle for active TDRS
            Ellipse:
                pos: self.pos
                size: self.size

    Widget:
        id: TDRS10_track
        canvas:
            Color:
                rgba: 0, 0, 1, 0.5  # Blue, semi-transparent
            Line:
                points: []
                width: max(1, dp(0.5))  # Responsive line width

    Widget:
        id: TDRS11
        size_hint: None, None
        size: min(dp(16), self.parent.width * 0.006), min(dp(16), self.parent.height * 0.006)  # Responsive size
        pos: 0, 0
        canvas:
            Color:
                rgba: 0, 0, 1, 1  # Blue
            Ellipse:
                pos: self.pos
                size: self.size

    # Active TDRS circle for TDRS11
    Widget:
        id: TDRS11_active_circle
        size_hint: None, None
        size: min(dp(32), self.parent.width * 0.012), min(dp(32), self.parent.height * 0.012)  # Responsive size
        pos: 0, 0
        canvas:
            Color:
                rgba: 1, 1, 0, 0  # Yellow circle for active TDRS
            Ellipse:
                pos: self.pos
                size: self.size

    Widget:
        id: TDRS11_track
        canvas:
            Color:
                rgba: 0, 0, 1, 0.5  # Blue, semi-transparent
            Line:
                points: []
                width: max(1, dp(0.5))  # Responsive line width

    # ───────────────────────────── User Location ───────────────────────────
    Widget:
        id: user_location
        size_hint: None, None
        size: min(dp(12), self.parent.width * 0.01), min(dp(12), self.parent.height * 0.01)  # Responsive size
        pos: 0, 0  # Will be set in Python
        canvas:
            Color:
                rgba: 1, 0, 1, 1  # Magenta dot
            Ellipse:
                pos: self.pos
                size: self.size

    # ───────────────────────────── ZOE & ISS icons ─────────────────────────
    Widget:
        id: ZOE
        col: (1, 1, 0, .2)
        size_hint: None, None
        size: min(dp(6), self.parent.width * 0.005), min(dp(38), self.parent.height * 0.04)  # Responsive size
        pos_hint: {"center_x": 0.5, "center_y": 0.5}
        opacity: 0.2
        canvas:
            Color:
                rgba: self.col
            Ellipse:
                pos: self.pos
                size: self.size

    Label:
        id: ZOElabel
        text: "ZOE"
        color: (1, 1, 1, 1)
        pos_hint: {"center_x": 0.5, "center_y": 0.5}
        font_size: min(self.height * 0.30, dp(24))  # Responsive with max size
        size_hint_y: 0.20
        markup: True

    # ─────── orbit counters (left column) ───────
    TelemetryLabel:
        id: dailyorbit
        pos_hint: {"center_x": .08, "center_y": .70}
        text: "0"

    TelemetryLabel:
        id: totalorbits
        pos_hint: {"center_x": .08, "center_y": .50}
        text: "0"

    # ─────── orbital parameters (lower band) ───────
    GridLayout:
        cols: 3
        rows: 2
        size_hint_y: .15
        row_default_height: self.height / 3
        spacing: 0, dp(4)

        TelemetryLabel:
            id: latitude
            pos_hint: {"center_x": .12, "center_y": .22}
            text: "0.00"
        TelemetryLabel:
            id: altitude
            pos_hint: {"center_x": .35, "center_y": .22}
            text: "0.00"

        TelemetryLabel:
            id: longitude
            pos_hint: {"center_x": .13, "center_y": .185}
            text: "0.00"
        TelemetryLabel:
            id: inc
            pos_hint: {"center_x": .35, "center_y": .185}
            text: "0.00"

        TelemetryLabel:
            id: solarbeta
            pos_hint: {"center_x": .57, "center_y": .22}
            text: "0.00"
        TelemetryLabel:
            id: period
            pos_hint: {"center_x": .57, "center_y": .185}
            text: "0.00"

    # ─────── next-pass block (upper-right) ───────
    PassLabel:
        id: iss_next_pass1
        pos_hint: {"center_x": .92, "center_y": .60}
        text: "--"
    PassLabel:
        id: iss_next_pass2
        pos_hint: {"center_x": .92, "center_y": .55}
        text: "--"
    PassLabel:
        id: countdown
        pos_hint: {"center_x": .92, "center_y": .50}
        text: "--"
    PassLabel:
        id: ISSvisible
        pos_hint: {"center_x": .92, "center_y": .45}
        text: "--"

    # ─────── navigation buttons ───────
    NavButton:
        id: iss_pass_button
        pos_hint: {"center_x": .92, "center_y": .76}
        background_normal: f"{root.mimic_directory}/Mimic/Pi/imgs/orbit/ISSpassUnlit.png"
        on_release: app.root.current = "orbit_pass"

    NavButton:
        id: orbit_data_button
        size_hint: .20, .11
        pos_hint: {"center_x": .72, "center_y": .19}
        background_normal: f"{root.mimic_directory}/Mimic/Pi/imgs/orbit/OrbitDataUnlit.png"
        on_release: app.root.current = "orbit_data"

    # ─────── Arduino & signal icons (bottom-left) ───────
    Image:
        id: arduino
        source: f"{root.mimic_directory}/Mimic/Pi/imgs/signal/arduino_offline.png"
        size_hint_y: .15
        pos_hint: {"center_x": .14, "center_y": .08}
        anim_delay: .2
        fit_mode: "scale-down"

    TelemetryLabel:
        id: arduino_count
        pos_hint: {"center_x": .14, "center_y": .08}
        text: ""
        markup: True
        font_size: min(self.height * .30, dp(20))  # Responsive with max size

    Image:
        id: signal
        source: f"{root.mimic_directory}/Mimic/Pi/imgs/signal/pulse-transparent.zip"
        size_hint_y: .15
        pos_hint: {"center_x": .05, "center_y": .07}
        anim_delay: .12
        fit_mode: "scale-down"

    # ─────── back button (bottom-right) ───────
    Button:
        size_hint: 0.1, 0.11
        pos_hint: {"center_x": .9375, "center_y": .082}
        background_normal: f"{root.mimic_directory}/Mimic/Pi/imgs/eva/BackButton.png"
        background_down: self.background_normal.replace("BackButton.png", "BackButton_Down.png") if self.background_normal else ""
        on_release: app.root.current = "mimic"
