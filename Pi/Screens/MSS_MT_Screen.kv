#:import dp kivy.metrics.dp

<MTSpeedometer@Widget>:
    # Dynamic gauge for MT speed (cm/s)
    speed_cms: 0.0
    min_speed: 0.0
    max_speed: 5.5  # ~2.17 in/s, headroom above 2 in/s (5.08 cm/s)
    start_angle: -120.0
    end_angle: 120.0
    # clamp speed and compute angle mapping
    _clamped: min(max(self.speed_cms, self.min_speed), self.max_speed)
    _angle: (self.start_angle + (self._clamped - self.min_speed) / (self.max_speed - self.min_speed) * (self.end_angle - self.start_angle)) if (self.max_speed - self.min_speed) != 0 else 0
    canvas:
        Color:
            rgba: 1, 1, 1, 0.4
        # Arc background
        Line:
            ellipse: (self.center_x - self.width * 0.45, self.center_y - self.height * 0.45, self.width * 0.9, self.height * 0.9, 210, 330)
            width: dp(2)
        # Needle
        Color:
            rgba: 1, 0.2, 0.4, 1
        PushMatrix
        Rotate:
            angle: self._angle
            origin: self.center_x, self.center_y
        Line:
            points: [self.center_x, self.center_y, self.center_x + self.width * 0.4, self.center_y]
            width: dp(2)
        PopMatrix
        # Center cap
        Color:
            rgba: 1, 1, 1, 1
        Line:
            circle: (self.center_x, self.center_y, dp(3))

<MSS_MT_Screen>:
    name: 'mt'
    FloatLayout:
        #:import dp kivy.metrics.dp
        Image:
            id: MBS_MT_background
            source: f'{root.mimic_directory}/Mimic/Pi/imgs/robo/MBSbackground.png'
            fit_mode: "fill"
        Label:
            ##pos_hint: {"center_x": 0.5, "center_y": 0.8}
            ##text: 'Mobile Transporter'
            ##markup: True
            ##color: 1,0,1
            ##size_hint_y: 0.4
            ##font_size: min(self.height * 0.10, dp(32))
        Label:
            ##id: mt_ws_label
            ##pos_hint: {"center_x": 0.25, "center_y": 0.6}
            ##text: 'MT is at WS: '
            ##markup: True
            ##color: 1,1,1
            ##size_hint_y: 0.4
            ##font_size: self.height * 0.10
        Label:
            id: mt_ws_value
            pos_hint: {"center_x": 0.275, "center_y": 0.73}
            text: '0'
            markup: True
            color: root.signalcolor
            size_hint_y: 0.4
            font_size: min(self.height * 0.10, dp(28))
        Label:
            ##id: mt_positon_label
            ##pos_hint: {"center_x": 0.2, "center_y": 0.45}
            ##text: 'MT Position: '
            ##markup: True
            ##color: 1,1,1
            ##size_hint_y: 0.4
            ##font_size: self.height * 0.10
        Label:
            id: mt_position_value
            pos_hint: {"center_x": 0.275, "center_y": 0.65}
            text: '0'
            markup: True
            color: root.signalcolor
            size_hint_y: 0.4
            font_size: min(self.height * 0.10, dp(28))
        Label:
            ##id: mt_speed_label
            ##pos_hint: {"center_x": 0.22, "center_y": 0.3}
            ##text: 'MT Speed: '
            ##markup: True
            ##color: 1,1,1
            ##size_hint_y: 0.4
            ##font_size: self.height * 0.10
        Label:
            id: mt_speed_value
            pos_hint: {"center_x": 0.275, "center_y": 0.69}
            text: '0'
            markup: True
            color: root.signalcolor
            size_hint_y: 0.4
            font_size: min(self.height * 0.10, dp(28))
        Label:
            id: MCASpayload
            pos_hint: {"center_x": 0.275, "center_y": 0.32}
            text: '0'
            markup: True
            color: root.signalcolor
            size_hint_y: 0.4
            font_size: min(self.height * 0.10, dp(28))
        Label:
            id: POApayload
            pos_hint: {"center_x": 0.275, "center_y": 0.28}
            text: '0'
            markup: True
            color: root.signalcolor
            size_hint_y: 0.4
            font_size: min(self.height * 0.10, dp(28))
        Image:
            id: FloatingMT
            source: f'{root.mimic_directory}/Mimic/Pi/imgs/robo/MovingMT.png'
            size_hint_y: 0.09
            pos_hint: {"center_x": 0.62, "center_y": 0.375}
            fit_mode: "scale-down"
        Button:
            size_hint: 0.1,0.11
            pos_hint: {"center_x": 0.9375, "center_y": 0.082}
            background_normal: f'{root.mimic_directory}/Mimic/Pi/imgs/eva/BackButton.png'
            on_release: app.root.current = 'robo'
        Image:
            id: signal
            source: f"{root.mimic_directory}/Mimic/Pi/imgs/signal/pulse-transparent.zip"
            size_hint_y: 0.15
            anim_delay: 0.12
            anim_loop: 0
            fit_mode: "scale-down"
            pos_hint: {"center_x": 0.05, "center_y": 0.07}
        Image:
            id: arduino
            source: f"{root.mimic_directory}/Mimic/Pi/imgs/signal/arduino_offline.png"
            size_hint_y: 0.15
            anim_delay: 0.2
            anim_loop: 0
            pos_hint: {"center_x": 0.14, "center_y": 0.08}
            fit_mode: "scale-down"
        Label:
            id: arduino_count
            pos_hint: {"center_x": 0.14, "center_y": 0.08}
            text: ''
            markup: True
            color: 1,1,1
            font_size: self.height * 0.3
            size_hint_y: 0.5
        # MT Speedometer gauge
        MTSpeedometer:
            id: mt_speedometer
            size_hint: 0.25, 0.25
            pos_hint: {"right": 0.98, "top": 0.98}
        Label:
            text: f"{mt_speedometer.speed_cms:.2f} cm/s"
            color: 1,1,1,1
            size_hint: None, None
            size: self.texture_size
            pos_hint: {"right": 0.98, "top": 0.84}
            font_size: min(self.height * 0.20, dp(20))
